# v0.6.0 TDD Excellence Task List

> Test-Driven Development approach for Advanced Portfolio Management & Optimization
> Every feature starts with a failing test, following the Red-Green-Refactor cycle

## 🔴 Pre-Release: Test Suite Stabilization (REQUIRED FIRST)

### Critical Test Fixes (Day 1-2)
- [ ] **Fix BenchmarkAnalyzer Mock Setup**
  - Test First: Write integration test for real Yahoo Finance API fallback
  - Fix: Update mock expectations to match actual usage patterns
  - Verify: All 5 BenchmarkAnalyzer tests passing
  - Files: `test/ashfolio/financial/benchmark_analyzer_test.exs`

- [ ] **Resolve PubSub Async Test Issues**
  - Test First: Add proper async test helpers with wait_for patterns
  - Fix: Update AdvancedAnalyticsLive tests with proper subscriptions
  - Verify: No flaky test failures in CI
  - Files: `test/ashfolio_web/live/advanced_analytics_live_test.exs`

- [ ] **Fix YahooFinanceMock Warnings**
  - Test First: Create shared mock setup in test_helper.exs
  - Fix: Consolidate mock definitions to single location
  - Verify: Zero mock redefinition warnings
  - Files: `test/support/mocks.ex`, `test/test_helper.exs`

### Code Quality Improvements (Day 2)
- [ ] **Refactor Complex Functions**
  - Test First: Add characterization tests for current behavior
  - Refactor: Break down ErrorCategorizer (complexity: 15→9)
  - Refactor: Simplify ErrorFormatter (complexity: 14→9)
  - Verify: All tests still passing, Credo happy
  - Files: `lib/ashfolio/error_categorizer.ex`, `lib/ashfolio/error_formatter.ex`

## 🟢 Phase 1: Corporate Actions Foundation (Week 1-2)

### 1.1 Stock Split Handler
```elixir
# TEST FIRST - test/ashfolio/portfolio/corporate_actions/stock_split_test.exs
describe "Stock Split Processing" do
  test "2:1 forward split doubles shares, halves cost basis"
  test "1:2 reverse split halves shares, doubles cost basis"
  test "3:2 split handles fractional shares correctly"
  test "split adjusts all historical transactions"
  test "split maintains total portfolio value"
  test "handles splits for partial positions"
end
```

**Implementation Tasks:**
- [ ] Write comprehensive stock split tests (30+ test cases)
- [ ] Create StockSplit schema with Ash resource
- [ ] Implement split ratio calculator with Decimal precision
- [ ] Build transaction adjustment engine
- [ ] Add split history tracking
- [ ] Create LiveView UI for split management

**Acceptance Criteria:**
- All cost basis recalculations use Decimal
- Historical transactions show "adjusted for split" notation
- Total portfolio value unchanged post-split
- Performance: <100ms for 1000 transactions

### 1.2 Dividend Processing Engine
```elixir
# TEST FIRST - test/ashfolio/portfolio/corporate_actions/dividend_processor_test.exs
describe "Dividend Processing" do
  test "cash dividends increase cash balance"
  test "stock dividends increase share count"
  test "qualified dividends tagged for tax reporting"
  test "reinvested dividends create new tax lots"
  test "special dividends handled separately"
  test "foreign dividends include withholding"
end
```

**Implementation Tasks:**
- [ ] Write dividend processing tests (25+ cases)
- [ ] Create Dividend schema with tax attributes
- [ ] Implement DRIP (reinvestment) logic
- [ ] Build qualified dividend identifier
- [ ] Add foreign tax withholding calculator
- [ ] Integrate with tax planning module

**Acceptance Criteria:**
- Automatic tax categorization (qualified/ordinary)
- FIFO cost basis for reinvested dividends
- Foreign withholding tracking for tax credits
- Integration with existing transaction system

### 1.3 Merger & Acquisition Handler
```elixir
# TEST FIRST - test/ashfolio/portfolio/corporate_actions/merger_handler_test.exs
describe "Merger & Acquisition Processing" do
  test "all-stock merger converts symbols correctly"
  test "cash merger creates realized gain/loss"
  test "mixed consideration handles cash + stock"
  test "spin-offs allocate cost basis properly"
  test "maintains FIFO ordering through merger"
end
```

**Implementation Tasks:**
- [ ] Write M&A processing tests (20+ cases)
- [ ] Create MergerAction schema
- [ ] Implement symbol conversion engine
- [ ] Build cost basis allocation calculator
- [ ] Add cash consideration processor
- [ ] Create merger history tracker

## 🟢 Phase 2: Advanced Analytics (Week 3-4)

### 2.1 Maximum Drawdown Calculator
```elixir
# TEST FIRST - test/ashfolio/financial/risk/maximum_drawdown_test.exs
describe "Maximum Drawdown Calculation" do
  test "identifies peak-to-trough decline correctly"
  test "handles multiple drawdown periods"
  test "calculates current drawdown from peak"
  test "works with sparse data points"
  test "performance: <50ms for 10-year daily data"
end
```

**Implementation Tasks:**
- [ ] Write drawdown calculation tests
- [ ] Implement peak detection algorithm
- [ ] Build rolling window calculator
- [ ] Create drawdown recovery tracker
- [ ] Add visualization data generator
- [ ] Cache calculations in ETS

### 2.2 Risk Metrics Suite
```elixir
# TEST FIRST - test/ashfolio/financial/risk/metrics_test.exs
describe "Risk Metrics Calculation" do
  test "Sharpe ratio with risk-free rate"
  test "Sortino ratio (downside deviation)"
  test "portfolio volatility (standard deviation)"
  test "beta calculation vs benchmark"
  test "Value at Risk (VaR) 95% confidence"
  test "correlation matrix for holdings"
end
```

**Implementation Tasks:**
- [ ] Write comprehensive risk metric tests (40+ cases)
- [ ] Implement Sharpe ratio calculator
- [ ] Build Sortino ratio with downside focus
- [ ] Create volatility calculator with Decimal
- [ ] Add correlation matrix generator
- [ ] Implement VaR with historical method

### 2.3 Monte Carlo Simulation Engine
```elixir
# TEST FIRST - test/ashfolio/financial/simulation/monte_carlo_test.exs
describe "Monte Carlo Simulation" do
  test "generates 1000 scenarios in <2s"
  test "uses historical returns for parameters"
  test "confidence intervals are statistically valid"
  test "handles fat-tail distributions"
  test "retirement success rate calculation"
end
```

**Implementation Tasks:**
- [ ] Write simulation tests with deterministic seeds
- [ ] Implement random walk generator
- [ ] Build return distribution analyzer
- [ ] Create parallel simulation runner
- [ ] Add percentile calculator
- [ ] Generate visualization data

## 🟢 Phase 3: Interactive Charting (Week 5-6)

### 3.1 Advanced Chart Components
```elixir
# TEST FIRST - test/ashfolio_web/components/charts/interactive_test.exs
describe "Interactive Chart Components" do
  test "zoom maintains aspect ratio"
  test "pan respects data boundaries"
  test "tooltip shows accurate values"
  test "crosshair tracks mouse position"
  test "mobile touch gestures work"
end
```

**Implementation Tasks:**
- [ ] Write LiveView component tests
- [ ] Implement zoom/pan controls
- [ ] Build tooltip system
- [ ] Create crosshair tracker
- [ ] Add touch gesture support
- [ ] Optimize SVG rendering performance

### 3.2 Chart Data Pipeline
```elixir
# TEST FIRST - test/ashfolio/charts/data_pipeline_test.exs
describe "Chart Data Pipeline" do
  test "aggregates daily to monthly/yearly"
  test "handles missing data points"
  test "calculates moving averages"
  test "generates candlestick data"
  test "performance: <100ms for 5-year daily"
end
```

**Implementation Tasks:**
- [ ] Write data transformation tests
- [ ] Build time-series aggregator
- [ ] Implement moving average calculator
- [ ] Create candlestick generator
- [ ] Add data interpolation
- [ ] Cache processed data in ETS

## 🟢 Phase 4: Portfolio Optimization (Week 7-8)

### 4.1 Rebalancing Engine
```elixir
# TEST FIRST - test/ashfolio/portfolio/rebalancing/engine_test.exs
describe "Portfolio Rebalancing" do
  test "calculates target allocations"
  test "minimizes tax impact (tax-aware)"
  test "respects minimum trade sizes"
  test "handles fractional shares"
  test "generates rebalancing orders"
  test "estimates tax consequences"
end
```

**Implementation Tasks:**
- [ ] Write rebalancing logic tests (35+ cases)
- [ ] Implement target allocation calculator
- [ ] Build tax-aware trade optimizer
- [ ] Create trade size optimizer
- [ ] Add tax impact estimator
- [ ] Generate rebalancing report

### 4.2 Asset Allocation Analyzer
```elixir
# TEST FIRST - test/ashfolio/portfolio/allocation/analyzer_test.exs
describe "Asset Allocation Analysis" do
  test "categorizes by asset class"
  test "geographic allocation (US/International)"
  test "sector breakdown for equities"
  test "market cap distribution"
  test "style box classification"
end
```

**Implementation Tasks:**
- [ ] Write allocation analysis tests
- [ ] Build asset classifier
- [ ] Implement geographic analyzer
- [ ] Create sector mapper
- [ ] Add style box calculator
- [ ] Generate allocation reports

## 📊 Test Coverage Goals

### Minimum Coverage Requirements
- **New Features**: 100% test coverage before merge
- **Corporate Actions**: 95% branch coverage
- **Risk Calculations**: 100% coverage + edge cases
- **Chart Components**: 90% coverage + visual regression tests
- **Performance Tests**: All calculations <100ms

### Test Categories
```bash
# Run specific test categories during development
just test unit        # Fast feedback loop (<1s)
just test integration # Feature validation (<10s)
just test performance # Performance benchmarks
just test smoke       # Critical path validation
just test all         # Complete suite before merge
```

### TDD Workflow Enforcement
1. **Write Test First** - No implementation without failing test
2. **Red Phase** - Test fails with clear assertion
3. **Green Phase** - Minimal code to pass test
4. **Refactor Phase** - Improve code with tests passing
5. **Document** - Add @moduledoc and @doc with examples
6. **Benchmark** - Add performance test if applicable

## 🎯 Success Metrics

### Code Quality
- [ ] Zero test failures before starting new feature
- [ ] All Credo warnings resolved
- [ ] Dialyzer passing without errors
- [ ] Format check passing

### Performance
- [ ] All financial calculations <100ms
- [ ] Dashboard refresh <500ms
- [ ] Chart rendering <200ms
- [ ] Monte Carlo 1000 scenarios <2s

### Test Excellence
- [ ] 1800+ total tests (up from 1669)
- [ ] Zero flaky tests in CI
- [ ] All async tests properly isolated
- [ ] Mock usage minimized

## 📅 Sprint Planning

### Sprint 1 (Week 1-2): Foundation
- Fix all test failures (2 days)
- Implement stock splits (3 days)
- Implement dividends (3 days)
- Review & refactor (2 days)

### Sprint 2 (Week 3-4): Analytics
- Maximum drawdown (2 days)
- Risk metrics suite (4 days)
- Monte Carlo engine (3 days)
- Integration testing (1 day)

### Sprint 3 (Week 5-6): Visualization
- Interactive charts (4 days)
- Data pipeline (3 days)
- Mobile optimization (2 days)
- Visual testing (1 day)

### Sprint 4 (Week 7-8): Optimization
- Rebalancing engine (4 days)
- Asset allocation (3 days)
- Performance tuning (2 days)
- Documentation (1 day)

## 🚀 Definition of Done

Every feature must meet these criteria:
- [ ] All tests passing (unit, integration, performance)
- [ ] Test coverage >95% for new code
- [ ] Performance benchmarks met
- [ ] Credo and Dialyzer passing
- [ ] Documentation complete with examples
- [ ] LiveView UI implemented and tested
- [ ] Code review completed
- [ ] Merged to main with linear history

## 📝 Notes

- Always use Decimal for financial calculations
- Follow existing patterns in codebase (check Code GPS)
- Add performance tests for calculations >10ms
- Use ETS caching for expensive operations
- Maintain FIFO cost basis consistency
- Document all financial formulas with references

---

*This task list emphasizes Test-Driven Development excellence. Every feature begins with comprehensive tests that define behavior before implementation.*