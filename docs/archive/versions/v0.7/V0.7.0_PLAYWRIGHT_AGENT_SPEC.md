# v0.7.0 Playwright MCP Testing Agent Specification

> **Purpose**: Specialized agent for comprehensive UI testing of v0.7.0 Advanced Portfolio Analytics using Playwright MCP tools
> **Agent Type**: `v0.7.0-ui-tester`
> **Primary Focus**: Efficient Frontier visualization and mathematical validation

## Agent Overview

### Capabilities Required
- **Browser Automation**: Full Playwright MCP tool suite for web testing
- **Mathematical Validation**: Ability to extract and validate numerical data
- **Performance Monitoring**: Timing analysis and performance benchmarking
- **Visual Documentation**: Screenshot capture and visual regression detection
- **Error Detection**: Console monitoring and JavaScript error tracking

### Target Features
- Efficient Frontier Analysis (flagship v0.7.0 feature)
- Portfolio optimization display (3 optimal portfolios)
- Mathematical accuracy validation
- Integration with existing analytics
- Real-time updates and caching

## Critical Test Scenarios

### 1. **Efficient Frontier Flagship Test**
**Goal**: Validate the core v0.7.0 feature works perfectly

```javascript
// Performance validation
const startTime = Date.now();
await page.click('button:has-text("Calculate Efficient Frontier")');
await page.waitForSelector('text=Minimum Variance Portfolio', { timeout: 5000 });
const calculationTime = Date.now() - startTime;
assert(calculationTime < 500, `Calculation took ${calculationTime}ms, expected <500ms`);
```

**Key Validations**:
- âœ… Calculation completes in <500ms
- âœ… Three portfolio cards appear (blue/green/purple)
- âœ… Proper card positioning and animation
- âœ… No JavaScript console errors

### 2. **Mathematical Accuracy Validation**
**Goal**: Ensure financial calculations are mathematically sound

```javascript
// Extract portfolio data for validation
const portfolios = await page.evaluate(() => {
  return {
    minVariance: extractPortfolioData('.bg-blue-50'),
    tangency: extractPortfolioData('.bg-green-50'),
    maxReturn: extractPortfolioData('.bg-purple-50')
  };
});

// Validate mathematical relationships
assert(portfolios.minVariance.volatility < portfolios.tangency.volatility);
assert(portfolios.tangency.volatility < portfolios.maxReturn.volatility);
assert(portfolios.tangency.sharpe > portfolios.minVariance.sharpe);
```

**Key Validations**:
- âœ… Tangency portfolio has highest Sharpe ratio
- âœ… Min variance has lowest volatility
- âœ… Portfolio weights sum to 100% (Â±0.01%)
- âœ… Risk-return ordering correct

### 3. **Integration Points Testing**
**Goal**: Verify seamless integration with existing analytics

```javascript
// Test Refresh All integration
await page.click('button:has-text("ðŸ”„ Refresh All Analytics")');
await page.waitForSelector('text=All analytics refreshed successfully');

// Verify Efficient Frontier included in batch operation
const historyIncludes = await page.textContent('[data-test="calculation-history"]');
assert(historyIncludes.includes('Efficient Frontier'));
```

**Key Validations**:
- âœ… Works with "Refresh All Analytics"
- âœ… Results properly cached
- âœ… Appears in calculation history
- âœ… PubSub updates trigger recalculation

### 4. **Cache Performance Testing**
**Goal**: Validate caching improves performance significantly

```javascript
// First calculation (cache miss)
const firstCalcTime = await timeCalculation();

// Second calculation (cache hit)
const secondCalcTime = await timeCalculation();

assert(secondCalcTime < 100, `Cached calculation took ${secondCalcTime}ms, expected <100ms`);
assert(secondCalcTime < firstCalcTime / 3, 'Cache should provide 3x+ speedup');
```

## Test Execution Protocol

### Pre-Test Setup
1. **Environment Verification**
   ```bash
   just server bg  # Start background server
   curl -f http://localhost:4000/health  # Verify server health
   ```

2. **Test Data Requirements**
   - Portfolio with at least 3 different asset types (STOCK, BOND, REIT)
   - Sufficient transaction history for TWR/MWR calculations
   - Clear performance cache before testing

3. **Browser Initialization**
   ```javascript
   await page.goto('http://localhost:4000/advanced_analytics');
   await page.setViewportSize({ width: 1920, height: 1080 });
   ```

### Test Execution Sequence

#### Phase 1: Baseline Validation
1. Navigate to Advanced Analytics page
2. Verify page loads correctly with all cards present
3. Take initial screenshot: `advanced-analytics-initial.png`
4. Verify no JavaScript errors in console

#### Phase 2: Efficient Frontier Core Testing
1. **Performance Test**: Time calculation execution
2. **Visual Test**: Verify three portfolio cards appear
3. **Data Test**: Extract and validate numerical values
4. **Mathematical Test**: Verify optimization relationships
5. Take screenshot: `efficient-frontier-results.png`

#### Phase 3: Integration Testing
1. **Refresh All Test**: Execute batch calculation
2. **Cache Test**: Verify caching behavior
3. **History Test**: Check calculation appears in history
4. **PubSub Test**: Create transaction and verify updates

#### Phase 4: Edge Case Testing
1. **Performance Stress**: Rapid button clicks
2. **Error Handling**: Invalid data scenarios
3. **Responsive Design**: Multiple viewport sizes
4. **Accessibility**: Keyboard navigation

### Success Criteria Matrix

| Test Category | Critical Requirements | Validation Method |
|---------------|----------------------|-------------------|
| **Performance** | Calculation <500ms, Cache hit <100ms | `console.time()` measurement |
| **Mathematical** | Correct Sharpe ratios, weight sums | JavaScript data extraction |
| **Visual** | Color coding, positioning, animations | Screenshot comparison |
| **Integration** | Cache, history, PubSub updates | Feature interaction testing |

### Error Handling Protocol

#### JavaScript Errors
```javascript
page.on('console', msg => {
  if (msg.type() === 'error') {
    console.error('Page error:', msg.text());
  }
});

const errors = await page.evaluate(() => window.errors || []);
assert(errors.length === 0, `Found ${errors.length} JavaScript errors`);
```

#### Network Failures
```javascript
page.on('response', response => {
  if (response.status() >= 400) {
    console.warn(`HTTP ${response.status()}: ${response.url()}`);
  }
});
```

#### Timeout Handling
- Default timeout: 5 seconds for calculations
- Extended timeout: 10 seconds for "Refresh All"
- Cache hit timeout: 1 second maximum

### Documentation Requirements

#### Screenshots Needed
1. `advanced-analytics-initial.png` - Clean page load
2. `efficient-frontier-calculating.png` - Loading state
3. `efficient-frontier-results.png` - Complete results
4. `portfolio-cards-detail.png` - Close-up of cards
5. `mathematical-validation.png` - Console validation output
6. `cache-performance.png` - Performance metrics
7. `integration-complete.png` - Full dashboard state

#### Performance Metrics to Record
- Initial calculation time (target: <500ms)
- Cached calculation time (target: <100ms)
- Total refresh time (target: <2000ms)
- Cache hit rate after full test suite
- Memory usage during calculations

#### Mathematical Results to Validate
- Minimum Variance Portfolio: Return %, Volatility %, Weights
- Tangency Portfolio: Return %, Volatility %, Sharpe Ratio, Weights
- Maximum Return Portfolio: Return %, Volatility %, Weights
- Weight summation verification (100% Â± 0.01%)
- Risk-return ordering validation

## Agent Completion Criteria

### Test Execution Complete When:
- [ ] All 15 test sections completed successfully
- [ ] All mathematical validations pass
- [ ] Performance benchmarks met
- [ ] Screenshots captured with proper naming
- [ ] Console shows zero JavaScript errors
- [ ] Integration points verified working
- [ ] Final assessment document populated

### Deliverables Expected:
1. **Completed Test Checklist**: All checkboxes marked
2. **Coverage Assessment**: Filled with actual results
3. **Screenshot Collection**: 7+ images documenting functionality
4. **Performance Report**: Timing data for all calculations
5. **Issue Log**: Any problems discovered during testing
6. **Mathematical Validation**: Proof that optimization is correct

## Risk Mitigation

### High-Risk Areas to Monitor:
1. **Calculation Failures**: Optimization algorithms may fail with edge cases
2. **Performance Degradation**: Complex calculations could exceed time limits
3. **Cache Corruption**: Invalid cache states could cause incorrect results
4. **Integration Breaks**: Changes to existing analytics could affect new features

### Fallback Strategies:
1. **Graceful Degradation**: Verify error messages are user-friendly
2. **Performance Alternatives**: Document any calculations exceeding targets
3. **Manual Verification**: Cross-check mathematical results with known formulas
4. **Isolation Testing**: Test Efficient Frontier independently if integration fails

---

This specification provides a comprehensive framework for automated testing of the v0.7.0 Efficient Frontier feature using Playwright MCP tools, ensuring both functional correctness and mathematical accuracy.