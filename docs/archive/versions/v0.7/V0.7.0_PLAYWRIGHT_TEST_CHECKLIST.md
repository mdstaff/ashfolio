# v0.7.0 Advanced Portfolio Analytics - Playwright MCP Test Checklist

> **Purpose**: Comprehensive UI testing checklist for the v0.7.0 Advanced Portfolio Analytics using Playwright MCP tools
> **Target Agent**: Next agent handling UI/UX validation for portfolio optimization features
> **Status**: Ready for execution

## Prerequisites

### Test Environment Setup

- [ ] Server running: `just server bg` or `just dev`
- [ ] Navigate to: `http://localhost:4000/advanced_analytics`
- [ ] Test data: Portfolio with transactions (AAPL, MSFT, GOOGL, SPY, VTI)

### Browser Tools Required

- `mcp__playwright__browser_navigate`
- `mcp__playwright__browser_snapshot`
- `mcp__playwright__browser_click`
- `mcp__playwright__browser_wait_for`
- `mcp__playwright__browser_evaluate`
- `mcp__playwright__browser_take_screenshot`
- `mcp__playwright__browser_console_messages`

## Test Scenarios

### 1. Advanced Analytics Page Load

#### 1.1 Initial Page State

- [ ] Navigate to `/advanced_analytics`
- [ ] Verify page title: "Advanced Analytics ¬∑ Ashfolio"
- [ ] Confirm heading: "Advanced Portfolio Analytics"
- [ ] Verify all action buttons present:
  - [ ] "üîÑ Refresh All Analytics"
  - [ ] "üìä Cache Stats"
  - [ ] "üóëÔ∏è Clear Cache"

#### 1.2 Analytics Cards Layout

- [ ] Verify TWR card is visible with "Calculate" button
- [ ] Verify MWR card is visible with "Calculate" button
- [ ] Check Risk Analytics Suite card present
- [ ] Check Rolling Returns Analysis card present
- [ ] Verify Efficient Frontier Analysis card present
- [ ] Confirm responsive grid layout (1 column mobile, 2 columns desktop)

### 2. Time-Weighted Return (TWR) Testing

#### 2.1 TWR Calculation

- [ ] Click "Calculate" button in TWR card
- [ ] Verify loading spinner appears
- [ ] Wait for calculation to complete (<2s)
- [ ] Check TWR percentage displays (e.g., "15.00%")
- [ ] Confirm "Eliminates impact of cash flow timing" description

#### 2.2 TWR Error Handling

- [ ] Test with empty portfolio (if possible)
- [ ] Verify appropriate error message displays
- [ ] Check error styling (red background/border)

### 3. Money-Weighted Return (MWR) Testing

#### 3.1 MWR Calculation

- [ ] Click "Calculate" button in MWR card
- [ ] Verify loading spinner appears
- [ ] Wait for calculation to complete (<2s)
- [ ] Check MWR percentage displays (e.g., "13.33%")
- [ ] Verify "Your personal return experience" subtitle
- [ ] Confirm "IRR-based calculation including timing" description

### 4. Risk Metrics Analysis

#### 4.1 Risk Metrics Calculation

- [ ] Click "Calculate Risk Metrics" button
- [ ] Verify loading state
- [ ] Check all metric cards appear:
  - [ ] Sharpe Ratio (blue card)
  - [ ] Sortino Ratio (green card)
  - [ ] Maximum Drawdown (red card)
  - [ ] Value at Risk 95% (orange card)
- [ ] Verify Risk Analysis Summary section appears
- [ ] Check all values are formatted correctly (percentages, decimals)

#### 4.2 Risk Metrics Details

- [ ] Verify Sharpe Ratio includes volatility
- [ ] Check Sortino Ratio shows downside deviation
- [ ] Confirm Maximum Drawdown shows recovery periods
- [ ] Verify VaR shows both amount and percentage

### 5. Rolling Returns Analysis

#### 5.1 Rolling Returns Calculation

- [ ] Click "Analyze" button in Rolling Returns card
- [ ] Verify loading animation
- [ ] Wait for analysis to complete
- [ ] Check display of:
  - [ ] Best 12-Month Period
  - [ ] Worst 12-Month Period
  - [ ] Average Return
  - [ ] Volatility
  - [ ] Number of periods analyzed

### 6. Efficient Frontier Analysis (NEW - CRITICAL TEST)

#### 6.1 Efficient Frontier Calculation

- [ ] Click "Calculate Efficient Frontier" button
- [ ] Verify loading spinner appears with text "Calculating Efficient Frontier..."
- [ ] Check three portfolio cards appear in correct order:
  - [ ] Minimum Variance Portfolio (blue) - leftmost position
  - [ ] Tangency Portfolio (green) - center position
  - [ ] Maximum Return Portfolio (purple) - rightmost position
- [ ] Verify cards animate in smoothly (fade-in effect)
- [ ] Check no JavaScript errors in console during calculation

#### 6.2 Portfolio Points Display

- [ ] **Minimum Variance Portfolio Card**:

  - [ ] Shows expected return percentage (format: "X.XX%")
  - [ ] Shows risk (volatility) percentage (format: "X.XX%")
  - [ ] Displays "Lowest risk combination" label
  - [ ] Blue color scheme applied (bg-blue-50, text-blue-700)
  - [ ] **VALIDATION**: Verify this has the LOWEST volatility of all three portfolios
  - [ ] Card has proper shadow and border styling

- [ ] **Tangency Portfolio Card**:

  - [ ] Shows expected return percentage (format: "X.XX%")
  - [ ] Shows risk (volatility) percentage (format: "X.XX%")
  - [ ] Shows Sharpe ratio value (format: "X.XX")
  - [ ] Displays "Best risk-adjusted return" label
  - [ ] Green color scheme applied (bg-green-50, text-green-700)
  - [ ] **VALIDATION**: Verify this has the HIGHEST Sharpe ratio
  - [ ] **VALIDATION**: Sharpe ratio = (Return - Risk-Free Rate) / Volatility
  - [ ] Card has proper shadow and border styling

- [ ] **Maximum Return Portfolio Card**:
  - [ ] Shows expected return percentage (format: "X.XX%")
  - [ ] Shows risk (volatility) percentage (format: "X.XX%")
  - [ ] Displays "Highest expected return" label
  - [ ] Purple color scheme applied (bg-purple-50, text-purple-700)
  - [ ] **VALIDATION**: Verify this has the HIGHEST expected return of all three portfolios
  - [ ] Card has proper shadow and border styling

#### 6.3 Portfolio Allocations Section

- [ ] Verify "Optimal Portfolio Allocations" heading is visible
- [ ] Check three columns of allocations display correctly:
  - [ ] Minimum Variance weights column (blue header)
  - [ ] Tangency Portfolio weights column (green header)
  - [ ] Maximum Return weights column (purple header)
- [ ] **For each portfolio allocation**:
  - [ ] All asset symbols displayed (STOCK, BOND, REIT)
  - [ ] Percentages shown with 2 decimal places (e.g., "45.32%")
  - [ ] **CRITICAL VALIDATION**: Sum of weights = 100.00% (¬±0.01% tolerance)
  - [ ] No negative weights (long-only constraint)
  - [ ] At least one non-zero weight per portfolio
- [ ] **Mathematical Validation**:
  - [ ] Maximum Return portfolio should have 100% in highest return asset
  - [ ] Minimum Variance should have diversified allocation
  - [ ] Tangency portfolio weights should be between Min Var and Max Return
- [ ] Check color coding matches portfolio cards (blue/green/purple)
- [ ] Verify table has proper borders and spacing

#### 6.4 Frontier Statistics

- [ ] Verify "Efficient Frontier Analysis" section
- [ ] Check statistics display:
  - [ ] Portfolios Generated count
  - [ ] Assets list (STOCK, BOND, REIT)
  - [ ] Optimization method (Markowitz Mean-Variance)
  - [ ] Risk Range (min to max volatility)
- [ ] Verify help text about interactive chart

### 7. Refresh All Analytics (Integration Test)

#### 7.1 Batch Calculation

- [ ] Click "üîÑ Refresh All Analytics" button
- [ ] Verify button shows loading state with spinner
- [ ] Check all analytics calculate sequentially:
  - [ ] TWR updates (check loading ‚Üí result transition)
  - [ ] MWR updates (check loading ‚Üí result transition)
  - [ ] Risk Metrics populate (all 4 metrics appear)
  - [ ] Rolling Returns complete (shows periods analyzed)
  - [ ] **CRITICAL**: Efficient Frontier generates successfully
- [ ] Verify success flash message: "All analytics refreshed successfully"
- [ ] Confirm all results display simultaneously
- [ ] **INTEGRATION**: TBD Efficient Frontier appears in calculation history

### 9. Calculation History (Integration)

#### 9.1 History Display

- [ ] After performing calculations, check "Recent Calculations" section
- [ ] Verify entries show:
  - [ ] Calculation type (TWR, MWR, Risk Metrics, Rolling Returns, **Efficient Frontier**)
  - [ ] Result or status message
  - [ ] Timestamp (HH:MM:SS format)
- [ ] **CRITICAL**: Verify Efficient Frontier entry shows:
  - [ ] "Efficient Frontier" as calculation type
  - [ ] "3 optimal portfolios generated" or similar message
  - [ ] Green success indicator (‚úì)
  - [ ] Accurate timestamp
- [ ] Check entries are sorted by time (newest first)
- [ ] Verify maximum 5 entries displayed (oldest auto-removed)
- [ ] **INTEGRATION**: After "Refresh All":
  - [ ] All 5 calculation types should appear in history
  - [ ] All should have green success indicators

### 10. Help Section Validation

#### 10.1 Educational Content

- [ ] Scroll to "Understanding Your Analytics" section
- [ ] Verify all help cards present:
  - [ ] Time-Weighted Return explanation
  - [ ] Money-Weighted Return explanation
  - [ ] Sharpe Ratio explanation
  - [ ] Sortino Ratio explanation
  - [ ] Maximum Drawdown explanation
  - [ ] Value at Risk explanation
  - [ ] Rolling Returns explanation
  - [ ] Efficient Frontier explanation
- [ ] Check readability and formatting

### 11. UI / UX Testing

#### 11.1 UI Responsiveness

- [ ] Check no UI freezing during calculations
- [ ] Verify smooth loading animations
- [ ] Test rapid button clicks (debouncing)
- [ ] Confirm scrolling remains smooth

### 12. Error State Testing

#### 12.1 Network Errors

- [ ] Test with server stopped (if possible)
- [ ] Verify error messages display appropriately
- [ ] Check retry functionality

#### 12.2 Invalid Data

- [ ] Test with malformed portfolio data
- [ ] Verify graceful error handling
- [ ] Check error messages are user-friendly

### 13. Responsive Design Testing

#### 13.1 Mobile View

- [ ] Resize to mobile viewport (375px)
- [ ] Verify cards stack vertically
- [ ] Check button sizes remain clickable
- [ ] Verify text remains readable
- [ ] Test horizontal scrolling (should not be needed)

#### 13.2 Tablet View

- [ ] Resize to tablet viewport (768px)
- [ ] Verify 2-column layout where appropriate
- [ ] Check spacing and alignment

#### 13.3 Desktop View

- [ ] Full desktop viewport (1920px)
- [ ] Verify optimal use of space
- [ ] Check multi-column layouts

### 14. Accessibility Testing

#### 14.1 Keyboard Navigation

- [ ] Tab through all interactive elements
- [ ] Verify focus indicators visible
- [ ] Test Enter/Space on buttons
- [ ] Check tab order is logical

#### 14.2 Screen Reader Compatibility

- [ ] Check ARIA labels present
- [ ] Verify heading hierarchy (h1, h2, h3)
- [ ] Test loading state announcements
- [ ] Verify result announcements

### 15. Real-time Updates (PubSub Integration)

#### 15.1 Transaction Updates

- [ ] Open Advanced Analytics in Tab 1
- [ ] Calculate Efficient Frontier (note the results)
- [ ] Open Transactions page in Tab 2
- [ ] Create a new transaction with significant amount
- [ ] Switch back to Tab 1 (Advanced Analytics)
- [ ] **CRITICAL VALIDATIONS**:
  - [ ] Flash message appears: "Portfolio updated. Refresh analytics for latest calculations."
  - [ ] Efficient Frontier results cleared (showing stale indicator)
  - [ ] "Refresh needed" badge appears on Efficient Frontier card
- [ ] Click "Calculate Efficient Frontier" again
- [ ] **VERIFY**: New results differ from original (due to new transaction)
- [ ] **CACHE**: Check that cache was properly invalidated

## JavaScript Console Monitoring

### Expected Console Messages

- [ ] Phoenix LiveView mount messages (normal)
- [ ] "Calculating [metric]" debug messages
- [ ] "Using cached result" messages when applicable
- [ ] No JavaScript errors

### Error Conditions to Watch

- [ ] No "undefined" or "null" reference errors
- [ ] No failed network requests (404, 500)
- [ ] No React/LiveView reconciliation errors
- [ ] No memory leaks during repeated calculations

## Test Execution Commands for Agent

```javascript
// Navigate to Advanced Analytics
await page.goto("http://localhost:4000/advanced_analytics");

// Take initial screenshot
await page.screenshot({
  path: "advanced-analytics-initial.png",
  fullPage: true,
});

// CRITICAL TEST 2: Mathematical Validation
const minVariance = await page.evaluate(() => {
  const card = document.querySelector(".bg-blue-50");
  return {
    return: parseFloat(card.querySelector(".text-lg").textContent),
    volatility: parseFloat(card.querySelectorAll(".text-sm")[0].textContent),
  };
});

const tangency = await page.evaluate(() => {
  const card = document.querySelector(".bg-green-50");
  return {
    return: parseFloat(card.querySelector(".text-lg").textContent),
    volatility: parseFloat(card.querySelectorAll(".text-sm")[0].textContent),
    sharpe: parseFloat(card.querySelectorAll(".text-sm")[1].textContent),
  };
});

const maxReturn = await page.evaluate(() => {
  const card = document.querySelector(".bg-purple-50");
  return {
    return: parseFloat(card.querySelector(".text-lg").textContent),
    volatility: parseFloat(card.querySelectorAll(".text-sm")[0].textContent),
  };
});

// Validate mathematical relationships
console.assert(
  minVariance.volatility < tangency.volatility,
  "Min variance should have lowest volatility"
);
console.assert(
  maxReturn.return > tangency.return && tangency.return > minVariance.return,
  "Returns should be ordered"
);
console.assert(
  tangency.sharpe > 0,
  "Tangency should have positive Sharpe ratio"
);

// CRITICAL TEST 3: Weight Validation
const weights = await page.evaluate(() => {
  const tables = document.querySelectorAll(".grid-cols-3 table");
  return Array.from(tables).map((table) => {
    const rows = table.querySelectorAll("tr");
    let sum = 0;
    rows.forEach((row) => {
      const weight = parseFloat(
        row.querySelector("td:last-child")?.textContent || "0"
      );
      sum += weight;
    });
    return sum;
  });
});

weights.forEach((sum, i) => {
  console.assert(
    Math.abs(sum - 100) < 0.01,
    `Portfolio ${i} weights sum to ${sum}%, expected 100%`
  );
});

// Take screenshot of results
await page.screenshot({
  path: "efficient-frontier-results.png",
  fullPage: true,
});

// CRITICAL TEST 4: Integration with Refresh All
const refreshStartTime = Date.now();
await page.click('button:has-text("Refresh All Analytics")');
await page.waitForSelector("text=All analytics refreshed successfully");
const refreshTime = Date.now() - refreshStartTime;
console.assert(
  refreshTime < 2000,
  `Refresh All took ${refreshTime}ms, expected <2000ms`
);

// Verify Efficient Frontier in calculation history
const historyHasFrontier = await page.evaluate(() => {
  const history = document.querySelector('[data-test="calculation-history"]');
  return history?.textContent?.includes("Efficient Frontier") || false;
});
console.assert(
  historyHasFrontier,
  "Efficient Frontier should appear in calculation history"
);

// CRITICAL TEST 5: Cache Integration
await page.click('button:has-text("üìä Cache Stats")');

// Re-calculate to test cache hit
const cacheStartTime = Date.now();
await page.click('button:has-text("Calculate Efficient Frontier")');
await page.waitForSelector("text=Minimum Variance Portfolio");
const cacheTime = Date.now() - cacheStartTime;
console.assert(
  cacheTime < 100,
  `Cached calculation took ${cacheTime}ms, expected <100ms`
);

// Check console for errors
const messages = await page.evaluate(() => {
  return window.consoleMessages || [];
});
const errors = messages.filter((m) => m.type === "error");
console.assert(errors.length === 0, `Found ${errors.length} console errors`);
```

## Expected Test Results

### Success Criteria

- [ ] All calculations complete without errors
- [ ] Efficient Frontier displays three optimal portfolios
- [ ] Portfolio weights sum to 100% for each portfolio
- [ ] No JavaScript console errors
- [ ] UI responsive and accessible
- [ ] Cache functionality works correctly

### Specific v0.7.0 Validation Points

- [ ] **Markowitz optimization** produces valid portfolios
- [ ] **Tangency portfolio** has highest Sharpe ratio
- [ ] **Min variance portfolio** has lowest volatility
- [ ] **Max return portfolio** allocated 100% to highest return asset
- [ ] **Asset allocation** displays use proper formatting (percentages)
- [ ] **Color coding** consistent (blue/green/purple)

## Notes for Testing Agent

1. **Critical Feature**: The Efficient Frontier is the flagship v0.7.0 feature - test thoroughly
2. **Mathematical Validation**: Verify portfolio optimization results make financial sense
3. **Integration**: Test how frontier integrates with other analytics
4. **Screenshots**: Capture the three portfolio cards and allocations for documentation
5. **Cache Behavior**: Verify frontier results are cached appropriately

This checklist provides comprehensive coverage for validating the v0.7.0 Advanced Portfolio Analytics with special focus on the new Efficient Frontier functionality using Playwright MCP tools.
