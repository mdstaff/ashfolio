# v0.3.0 Simplified Feature Specification

v0.3.0
Q4 2025 (6-8 weeks)
Essential Financial Analytics Foundation
Planning

## Overview

v0.3.0 represents a focused, pragmatic expansion that builds directly on v0.2.0's foundation without major architectural changes. This release prioritizes two essential features that deliver immediate user value while establishing the analytics foundation for future FIRE/retirement planning features.

## Implementation Approach Options

Given infrastructure analysis, we have three viable approaches:

### Option A: Simplified MVP (6-8 weeks)

- Expense tracking with basic tables/lists (no charts)
- Manual net worth snapshots only (no automation)
- Focus on core functionality and data collection

### Option B: Full Infrastructure (9-12 weeks)

- Complete charting and background job infrastructure
- Automated snapshots with full analytics
- All features as originally specified

### Option C: Sequential Delivery (8-10 weeks)

- Phase 1: Expense tracking complete (4 weeks)
- Phase 2: Net worth snapshots complete (4-6 weeks)
- Incremental feature deployment

## Core Features

### 1. Expense Tracking & Categorization

Enable comprehensive expense tracking to understand spending patterns and calculate essential FIRE metrics (annual expenses baseline).

- Replace manual spreadsheet expense tracking
- Understand monthly/annual spending patterns
- Essential for calculating FIRE number (25x annual expenses)
- Enable budget vs actual analysis

### 2. Net Worth Snapshots

Automated historical net worth tracking with time-series analysis for progress monitoring.

- Track financial progress over time
- Year-over-year growth analysis
- Visual motivation through progress charts
- Foundation for projections and forecasting

---

## Feature 1: Expense Tracking & Categorization

### Overview

Extend the existing financial management infrastructure to track and categorize expenses, providing insights into spending patterns essential for financial planning and FIRE calculations.

### Architecture Approach

- Build on existing `FinancialManagement` domain
- Reuse `TransactionCategory` system (already implemented)
- Link expenses to existing `Portfolio.Account` for payment source
- Follow established Ash resource patterns

### Data Model

```elixir
defmodule Ashfolio.FinancialManagement.Expense do
  use Ash.Resource,
    domain: Ashfolio.FinancialManagement,
    data_layer: AshSqlite.DataLayer

  attributes do
    uuid_primary_key(:id)

    attribute :description, :string, allow_nil?: false
    attribute :amount, :decimal, allow_nil?: false
    attribute :date, :date, allow_nil?: false
    attribute :merchant, :string
    attribute :notes, :text

    # For recurring expenses
    attribute :is_recurring, :boolean, default: false
    attribute :frequency, :atom do
      constraints one_of: [:monthly, :quarterly, :annual, :weekly, :biweekly]
    end

    timestamps()
  end

  relationships do
    belongs_to :category, Ashfolio.FinancialManagement.TransactionCategory do
      allow_nil?: false
    end

    belongs_to :account, Ashfolio.Portfolio.Account do
      # Payment source (checking, credit card, etc.)
      allow_nil?: false
    end
  end
end
```

### User Interface Components

#### 1. Expense Entry Form

- Date, amount, description, category
- Dropdown with existing TransactionCategory
- Which account paid for expense
- Mark as recurring with frequency

#### 2. Expense List View

- By date range, category, account
- Date, amount, category, description
- Delete, categorize multiple
- Find expenses by description/merchant

#### 3. Expense Analytics Dashboard

- Total expenses by month
- Pie chart of spending by category
- Line chart of monthly spending over time
- Actual vs expected (if budgets set)

### Implementation Tasks

#### Phase 1: Core Expense Resource (Week 1)

- [ ] Create Expense resource in FinancialManagement domain
- [ ] Add database migrations for expenses table
- [ ] Implement CRUD actions (create, read, update, delete)
- [ ] Add validation rules (amount > 0, valid dates)
- [ ] Create expense categories if not existing

#### Phase 2: LiveView Interface (Week 2)

- [ ] Create ExpenseLive.Index for listing expenses
- [ ] Create ExpenseLive.FormComponent for add/edit
- [ ] Implement filtering by date range and category
- [ ] Add pagination for large expense lists
- [ ] Create search functionality

#### Phase 3: Analytics & Reporting (Week 3)

- [ ] Create expense aggregation queries (by month, category)
- [ ] Build expense analytics LiveView component
- [ ] Implement category breakdown visualizations
- [ ] Add monthly/annual expense calculations
- [ ] Create CSV export functionality

#### Phase 4: Recurring Expenses (Week 4)

- [ ] Add recurring expense support to resource
- [ ] Create recurring expense generator job
- [ ] Build UI for managing recurring expenses
- [ ] Implement future expense projections

### Testing Strategy

- Unit tests for Expense resource CRUD operations
- Integration tests for expense categorization
- LiveView tests for expense forms and filtering
- Performance tests for expense aggregation queries

---

## Feature 2: Net Worth Snapshots

### Overview

Automated calculation and storage of net worth at regular intervals, providing historical tracking and trend analysis across all accounts.

### Architecture Approach

- Store point-in-time net worth calculations
- Optimize SQLite for time-series queries
- Use background jobs for automated snapshots
- Cache calculations in ETS for performance

### Data Model

```elixir
defmodule Ashfolio.FinancialManagement.NetWorthSnapshot do
  use Ash.Resource,
    domain: Ashfolio.FinancialManagement,
    data_layer: AshSqlite.DataLayer

  attributes do
    uuid_primary_key(:id)

    attribute :snapshot_date, :date, allow_nil?: false
    attribute :total_assets, :decimal, allow_nil?: false
    attribute :total_liabilities, :decimal, default: Decimal.new(0)
    attribute :net_worth, :decimal, allow_nil?: false

    # Breakdown by account type
    attribute :investment_value, :decimal
    attribute :cash_value, :decimal
    attribute :other_assets_value, :decimal

    # Metadata
    attribute :is_automated, :boolean, default: true
    attribute :notes, :text

    timestamps()
  end

  indexes do
    index [:snapshot_date], unique: true
  end
end
```

### Calculation Logic

```elixir
defmodule Ashfolio.FinancialManagement.NetWorthCalculator do
  @moduledoc """
  Calculates and stores net worth snapshots
  """

  def calculate_current_net_worth do
    # Sum all investment accounts (with current market values)
    investment_total = calculate_investment_accounts_value()

    # Sum all cash accounts
    cash_total = calculate_cash_accounts_value()

    # Future: Sum other assets when implemented
    other_assets = Decimal.new(0)

    # Future: Sum liabilities when implemented
    liabilities = Decimal.new(0)

    total_assets = Decimal.add(investment_total, cash_total)
    net_worth = Decimal.sub(total_assets, liabilities)

    %{
      total_assets: total_assets,
      total_liabilities: liabilities,
      net_worth: net_worth,
      investment_value: investment_total,
      cash_value: cash_total,
      other_assets_value: other_assets
    }
  end
end
```

### User Interface Components

#### 1. Net Worth Dashboard Widget

- Large display number
- +/- percentage
- Mini trend chart (last 12 months)
- View history, generate snapshot

#### 2. Net Worth History View

- Line chart with zoom/pan
- YTD, 1Y, 3Y, 5Y, All
- Stacked area chart by asset type
- Monthly snapshots with changes

#### 3. Snapshot Management

- Button to generate now
- Monthly on specific day
- Correct historical data
- CSV/Excel for external analysis

### Implementation Tasks

#### Phase 1: Core Snapshot Resource (Week 1)

- [ ] Create NetWorthSnapshot resource
- [ ] Add database migrations with indexes
- [ ] Implement snapshot creation action
- [ ] Create NetWorthCalculator module
- [ ] Add calculation tests

#### Phase 2: Automated Snapshots (Week 2)

- [ ] Set up Oban for background jobs
- [ ] Create monthly snapshot job
- [ ] Implement snapshot scheduling
- [ ] Add job monitoring/retry logic
- [ ] Create snapshot validation

#### Phase 3: LiveView Interface (Week 3)

- [ ] Create NetWorthLive.Index view
- [ ] Build dashboard widget component
- [ ] Implement history chart (using Chart.js)
- [ ] Add time range filtering
- [ ] Create export functionality

#### Phase 4: Analytics & Optimization (Week 4)

- [ ] Implement year-over-year comparisons
- [ ] Add growth rate calculations
- [ ] Optimize queries with proper indexes
- [ ] Add ETS caching for calculations
- [ ] Create performance benchmarks

### SQLite Performance Requirements

#### Critical Database Optimizations

```elixir
config :ashfolio, Ashfolio.Repo,
  pragma: [
    # Existing settings +
    cache_size: -256000,        # 256MB cache (up from 128MB)
    temp_store: :memory,        # Keep temp tables in memory
    mmap_size: 1073741824,      # 1GB memory mapping
    query_planner: true,        # Enable query planner optimizations
    optimize: 1000              # Auto-optimize after 1000 writes
  ]
```

```sql
-- Time-series performance for net worth
CREATE INDEX idx_snapshots_date ON net_worth_snapshots(snapshot_date DESC);
CREATE INDEX idx_snapshots_date_range ON net_worth_snapshots(snapshot_date, net_worth);

-- Expense analytics performance
CREATE INDEX idx_expenses_date ON expenses(date);
CREATE INDEX idx_expenses_category_date ON expenses(category_id, date);
CREATE INDEX idx_expenses_monthly ON expenses(DATE(date, 'start of month'));
CREATE INDEX idx_expenses_account_date ON expenses(account_id, date);
```

Caching Strategy (Required for acceptable performance):

- Cache current net worth in ETS (1 hour TTL)
- Cache monthly expense aggregates (24 hour TTL)
- Cache category totals for current month
- Invalidate on account/transaction/expense changes

- Generate 5 years of test expense data (~15k records)
- Benchmark aggregation queries with realistic data volume
- Monitor memory usage during complex calculations
- Test concurrent access (background jobs + user interaction)

### Testing Strategy

- Unit tests for calculation accuracy
- Integration tests for snapshot generation
- Job tests for automated scheduling
- Performance tests for historical queries
- LiveView tests for chart interactions

---

## Integration Points

### Shared Components

1.  Reusable for both features
2.  Consistent display across app
3.  CSV generation for both expenses and snapshots
4.  Shared charting library setup

### Database Relationships

```
Portfolio.Account ← Expense (payment source)
                 ← NetWorthSnapshot (value calculation)

TransactionCategory ← Expense (categorization)

NetWorthSnapshot (standalone time-series)
```

### Dashboard Integration

- Add expense summary widget to main dashboard
- Include net worth trend widget prominently
- Link to detailed views from widgets
- Maintain existing portfolio metrics

---

## Success Criteria

### Technical Metrics

- [ ] Expense entry completes in <500ms
- [ ] Net worth calculation in <2 seconds
- [ ] Historical queries return in <1 second
- [ ] 95%+ test coverage for new features

### User Experience Metrics

- [ ] Complete monthly expense entry in <10 minutes
- [ ] Clear visibility of spending patterns
- [ ] Motivating net worth progress visualization
- [ ] Seamless integration with existing UI

### Data Quality

- [ ] No data loss during calculations
- [ ] Accurate net worth at point-in-time
- [ ] Consistent categorization
- [ ] Reliable automated snapshots

---

## Critical Risks & Infrastructure Prerequisites

### MAJOR BLOCKERS Identified

#### 1. Background Job Infrastructure Missing

- Oban not installed, automated snapshots require background jobs
- +1-2 weeks for setup and configuration
- Choose Option A (manual snapshots) or add infrastructure time

#### 2. Charting Library Missing

- No charts for net worth visualization
- Chart.js, Contex, LiveView Native Charts, or table-only
- +1-2 weeks for integration
- Start with tables, add charts in v0.3.1

#### 3. SQLite Time-Series Performance Unknown

- First real time-series data, complex aggregations untested
- Performance degradation with realistic data volumes
- Add indexes upfront, implement caching, load testing

### Infrastructure Prerequisites

Required Dependencies (if choosing full implementation):

```elixir
# Add to mix.exs:
{:oban, "~> 2.17"},           # Background jobs
{:contex, "~> 0.5"},         # Charts (or alternative)
```

- Enhanced pragma configuration for time-series
- Multiple new indexes for aggregation performance
- ETS caching implementation for real-time calculations

### Recommended Risk Mitigation

#### Option A: Simplified MVP (Recommended for 6-8 week timeline)

- Full implementation with tables/filters
- Manual calculation only (no automation)
- Simple tables and basic statistics
- Minimal infrastructure risk, core value delivered

#### Option B: Infrastructure-First (9-12 week realistic timeline)

- Week 1-2: Add Oban, charting, enhanced SQLite config
- Week 3+: Implement features with full automation and visualization

#### Option C: Feature-Sequential (8-10 week compromise)

- Focus on expense tracking first (lower complexity)
- Add net worth snapshots after expense foundation solid

---

## Revised Development Timeline

### Option A: Simplified MVP (6-8 weeks - Recommended)

#### Week 1-2: Database Foundation

- [ ] Enhanced SQLite pragma configuration
- [ ] Create Expense resource with proper indexes
- [ ] Create NetWorthSnapshot resource
- [ ] Database migrations with performance indexes
- [ ] Basic calculation modules

#### Week 3-4: Core Functionality

- [ ] ExpenseLive CRUD interface (tables only)
- [ ] Manual net worth snapshot calculation
- [ ] Expense categorization and filtering
- [ ] Basic aggregation queries (monthly totals)

#### Week 5-6: Analytics Foundation

- [ ] Expense analytics (monthly/category breakdowns)
- [ ] Net worth history table view
- [ ] CSV export functionality
- [ ] ETS caching for calculations

#### Week 7-8: Integration & Polish

- [ ] Dashboard integration widgets
- [ ] Performance testing with realistic data
- [ ] Comprehensive test coverage
- [ ] Documentation and user guides

### Option B: Full Infrastructure (9-12 weeks - Complete Vision)

#### Week 1-2: Infrastructure Setup

- [ ] Add Oban dependency and configuration
- [ ] Add charting library (Contex/Chart.js)
- [ ] Enhanced SQLite configuration
- [ ] Background job supervisor setup

#### Week 3-4: Core Resources

- [ ] Expense and NetWorthSnapshot resources
- [ ] Database migrations with full indexing
- [ ] Background job definitions
- [ ] Calculation modules with caching

#### Week 5-7: User Interface

- [ ] ExpenseLive with charts and visualizations
- [ ] NetWorth trending with interactive charts
- [ ] Automated snapshot scheduling
- [ ] Advanced filtering and analytics

#### Week 8-9: Advanced Features

- [ ] Recurring expense automation
- [ ] Complex aggregation queries
- [ ] Real-time dashboard updates
- [ ] Export and reporting suite

#### Week 10-12: Optimization & Polish

- [ ] Performance optimization and benchmarking
- [ ] Comprehensive testing including job failures
- [ ] Documentation and deployment guides
- [ ] Load testing with 5+ years of data

---

## Future Extensibility

These features establish foundation for:

- FIRE calculations (using expense baseline)
- Retirement projections (using snapshot trends)
- Budget management (using expense categories)
- Tax reporting (using categorized expenses)

---

## Conclusion

This simplified v0.3.0 specification focuses on two high-value features that:

1. Build directly on existing v0.2.0 infrastructure
2. Require minimal architectural changes
3. Deliver immediate user value
4. Establish foundation for future planning features

The implementation is deliberately conservative, following established patterns and avoiding complex architectural refactoring.
