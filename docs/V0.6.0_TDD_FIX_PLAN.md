# TDD Approach: Fixing Corporate Actions Conditional Form Logic

## Problem Statement

The Corporate Actions form does not display conditional fields when action types are selected. This prevents users from creating any corporate actions as required fields are missing.

## TDD Implementation Plan

### Phase 1: Write Failing Tests (Red)

#### 1.1 LiveView Component Tests

```elixir
# test/ashfolio_web/live/corporate_action_live/form_component_test.exs

defmodule AshfolioWeb.CorporateActionLive.FormComponentTest do
  use AshfolioWeb.ConnCase
  import Phoenix.LiveViewTest

  describe "conditional field rendering" do
    setup [:create_test_symbols]

    test "displays split ratio fields when stock_split is selected", %{conn: conn} do
      {:ok, view, _html} = live(conn, ~p"/corporate-actions/new")

      # Select stock split action type
      view
      |> form("#corporate-action-form", %{
        "form" => %{"action_type" => "stock_split"}
      })
      |> render_change()

      # Assert split ratio fields are visible
      assert has_element?(view, "#form_split_ratio_from")
      assert has_element?(view, "#form_split_ratio_to")
      assert has_element?(view, "[data-role='split-details']")

      # Assert help text is visible
      assert view
             |> element(".help-text")
             |> render() =~ "For a 2:1 split"
    end

    test "displays dividend fields when cash_dividend is selected", %{conn: conn} do
      {:ok, view, _html} = live(conn, ~p"/corporate-actions/new")

      view
      |> form("#corporate-action-form", %{
        "form" => %{"action_type" => "cash_dividend"}
      })
      |> render_change()

      # Assert dividend fields are visible
      assert has_element?(view, "#form_dividend_amount")
      assert has_element?(view, "#form_dividend_currency")
      assert has_element?(view, "#form_qualified_dividend")
      assert has_element?(view, "[data-role='dividend-details']")
    end

    test "displays merger fields when merger is selected", %{conn: conn} do
      {:ok, view, _html} = live(conn, ~p"/corporate-actions/new")

      view
      |> form("#corporate-action-form", %{
        "form" => %{"action_type" => "merger"}
      })
      |> render_change()

      # Assert merger fields are visible
      assert has_element?(view, "#form_exchange_ratio")
      assert has_element?(view, "#form_cash_consideration")
      assert has_element?(view, "[data-role='merger-details']")
    end

    test "hides conditional fields when action type is cleared", %{conn: conn} do
      {:ok, view, _html} = live(conn, ~p"/corporate-actions/new")

      # First select an action type
      view
      |> form("#corporate-action-form", %{
        "form" => %{"action_type" => "stock_split"}
      })
      |> render_change()

      assert has_element?(view, "#form_split_ratio_from")

      # Then clear it
      view
      |> form("#corporate-action-form", %{
        "form" => %{"action_type" => ""}
      })
      |> render_change()

      # Assert fields are hidden
      refute has_element?(view, "#form_split_ratio_from")
      refute has_element?(view, "[data-role='split-details']")
    end
  end

  describe "form submission with conditional fields" do
    setup [:create_test_symbols]

    test "successfully creates stock split with ratio fields", %{conn: conn} do
      {:ok, view, _html} = live(conn, ~p"/corporate-actions/new")

      {:ok, _, html} =
        view
        |> form("#corporate-action-form", %{
          "form" => %{
            "action_type" => "stock_split",
            "symbol_id" => "aapl",
            "ex_date" => "2024-06-01",
            "description" => "2:1 stock split",
            "split_ratio_from" => "1",
            "split_ratio_to" => "2"
          }
        })
        |> render_submit()
        |> follow_redirect(conn, ~p"/corporate-actions")

      assert html =~ "Corporate action created successfully"
      assert html =~ "AAPL"
      assert html =~ "Stock Split"
      assert html =~ "2:1 stock split"
    end

    test "shows validation errors for missing split ratios", %{conn: conn} do
      {:ok, view, _html} = live(conn, ~p"/corporate-actions/new")

      view
      |> form("#corporate-action-form", %{
        "form" => %{
          "action_type" => "stock_split",
          "symbol_id" => "aapl",
          "ex_date" => "2024-06-01"
          # Missing split ratios
        }
      })
      |> render_submit()

      # Should show validation errors
      assert has_element?(view, ".invalid-feedback", "Split ratio from is required")
      assert has_element?(view, ".invalid-feedback", "Split ratio to is required")
    end
  end

  defp create_test_symbols(_) do
    {:ok, aapl} = Ashfolio.Portfolio.Symbol.create(%{
      ticker: "AAPL",
      name: "Apple Inc."
    })

    %{symbols: [aapl]}
  end
end
```

#### 1.2 Integration Tests

```elixir
# test/ashfolio_web/live/corporate_action_live_test.exs

test "complete workflow: create and apply stock split", %{conn: conn} do
  {:ok, view, _html} = live(conn, ~p"/corporate-actions/new")

  # Fill form with stock split data
  view
  |> form("#corporate-action-form", %{
    "form" => %{
      "action_type" => "stock_split",
      "symbol_id" => "aapl",
      "ex_date" => "2024-06-01",
      "split_ratio_from" => "1",
      "split_ratio_to" => "2",
      "description" => "2:1 split"
    }
  })
  |> render_submit()

  # Navigate to index
  {:ok, index_view, html} = live(conn, ~p"/corporate-actions")

  assert html =~ "AAPL"
  assert html =~ "Pending"

  # Click apply button
  index_view
  |> element("[data-action='apply'][data-id='1']")
  |> render_click()

  # Confirm in modal
  index_view
  |> element("#confirm-apply")
  |> render_click()

  # Check status changed
  assert render(index_view) =~ "Applied"
end
```

### Phase 2: Implement Minimal Code (Green)

#### 2.1 Update LiveView Component

```elixir
# lib/ashfolio_web/live/corporate_action_live/form_component.ex

defmodule AshfolioWeb.CorporateActionLive.FormComponent do
  use AshfolioWeb, :live_component

  @impl true
  def update(%{corporate_action: corporate_action} = assigns, socket) do
    changeset = CorporateActions.change_corporate_action(corporate_action)

    # Extract action type from changeset or existing record
    action_type = get_action_type(changeset, corporate_action)

    {:ok,
     socket
     |> assign(assigns)
     |> assign(:changeset, changeset)
     |> assign(:action_type, action_type)
     |> assign_new(:form, fn -> to_form(changeset) end)}
  end

  @impl true
  def handle_event("validate", %{"form" => params}, socket) do
    # Update action_type in assigns for conditional rendering
    action_type = params["action_type"] || ""

    changeset =
      socket.assigns.corporate_action
      |> CorporateActions.change_corporate_action(params)
      |> Map.put(:action, :validate)

    {:noreply,
     socket
     |> assign(:changeset, changeset)
     |> assign(:form, to_form(changeset))
     |> assign(:action_type, action_type)}
  end

  @impl true
  def handle_event("save", %{"form" => params}, socket) do
    save_corporate_action(socket, socket.assigns.action, params)
  end

  defp get_action_type(changeset, corporate_action) do
    Ecto.Changeset.get_field(changeset, :action_type) ||
      corporate_action.action_type ||
      ""
  end
end
```

#### 2.2 Update HEEx Template

```heex
<!-- lib/ashfolio_web/live/corporate_action_live/form_component.html.heex -->

<.simple_form
  for={@form}
  id="corporate-action-form"
  phx-target={@myself}
  phx-change="validate"
  phx-submit="save"
>
  <.input
    field={@form[:action_type]}
    type="select"
    label="Action Type"
    options={action_type_options()}
    prompt="Select action type..."
    required
  />

  <.input
    field={@form[:symbol_id]}
    type="select"
    label="Symbol"
    options={symbol_options(@symbols)}
    prompt="Select symbol..."
    required
  />

  <!-- Conditional Fields Based on Action Type -->
  <%= if @action_type == "stock_split" do %>
    <div data-role="split-details" class="mt-6 p-4 bg-gray-50 rounded-lg">
      <h3 class="text-lg font-medium mb-4">Stock Split Details</h3>

      <div class="grid grid-cols-2 gap-4">
        <.input
          field={@form[:split_ratio_from]}
          type="number"
          label="Split Ratio From"
          placeholder="1"
          min="1"
          required
        />

        <.input
          field={@form[:split_ratio_to]}
          type="number"
          label="Split Ratio To"
          placeholder="2"
          min="1"
          required
        />
      </div>

      <p class="help-text text-sm text-gray-600 mt-2">
        For a 2:1 split (1 share becomes 2), enter From: 1, To: 2
      </p>
    </div>
  <% end %>

  <%= if @action_type in ["cash_dividend", "stock_dividend", "return_of_capital"] do %>
    <div data-role="dividend-details" class="mt-6 p-4 bg-gray-50 rounded-lg">
      <h3 class="text-lg font-medium mb-4">Dividend Details</h3>

      <div class="grid grid-cols-2 gap-4">
        <.input
          field={@form[:dividend_amount]}
          type="number"
          label="Dividend Amount"
          placeholder="1.00"
          step="0.01"
          min="0.01"
          required
        />

        <.input
          field={@form[:dividend_currency]}
          type="select"
          label="Currency"
          options={[{"USD", "USD"}, {"CAD", "CAD"}, {"EUR", "EUR"}, {"GBP", "GBP"}]}
          default="USD"
        />
      </div>

      <%= if @action_type == "cash_dividend" do %>
        <.input
          field={@form[:qualified_dividend]}
          type="checkbox"
          label="Qualified Dividend"
        />
      <% end %>
    </div>
  <% end %>

  <%= if @action_type == "merger" do %>
    <div data-role="merger-details" class="mt-6 p-4 bg-gray-50 rounded-lg">
      <h3 class="text-lg font-medium mb-4">Merger Details</h3>

      <.input
        field={@form[:exchange_ratio]}
        type="number"
        label="Exchange Ratio"
        placeholder="1.5"
        step="0.001"
        min="0"
      />

      <.input
        field={@form[:cash_consideration]}
        type="number"
        label="Cash Consideration"
        placeholder="0.00"
        step="0.01"
        min="0"
      />

      <p class="help-text text-sm text-gray-600 mt-2">
        At least one of exchange ratio or cash consideration is required
      </p>
    </div>
  <% end %>

  <%= if @action_type == "spinoff" do %>
    <div data-role="spinoff-details" class="mt-6 p-4 bg-gray-50 rounded-lg">
      <h3 class="text-lg font-medium mb-4">Spinoff Details</h3>

      <.input
        field={@form[:new_symbol_id]}
        type="select"
        label="New Symbol"
        options={symbol_options(@symbols)}
        prompt="Select new symbol..."
        required
      />

      <.input
        field={@form[:exchange_ratio]}
        type="number"
        label="Exchange Ratio"
        placeholder="1"
        step="0.001"
        min="0.001"
        required
      />
    </div>
  <% end %>

  <!-- Common Fields -->
  <.input
    field={@form[:ex_date]}
    type="date"
    label="Ex-Date"
    required
  />

  <.input
    field={@form[:description]}
    type="textarea"
    label="Description"
    placeholder="Brief description of the action"
  />

  <:actions>
    <.button phx-disable-with="Saving..." type="submit">
      <%= if @action == :edit, do: "Update", else: "Create" %> Corporate Action
    </.button>
    <.button type="button" phx-click="cancel" phx-target={@myself}>
      Cancel
    </.button>
  </:actions>
</.simple_form>
```

### Phase 3: Refactor (Clean)

#### 3.1 Extract Conditional Logic to Helper Functions

```elixir
# lib/ashfolio_web/live/corporate_action_live/form_component.ex

defmodule AshfolioWeb.CorporateActionLive.FormComponent do
  # ... existing code ...

  # Helper functions for template
  def show_split_fields?("stock_split"), do: true
  def show_split_fields?(_), do: false

  def show_dividend_fields?(type) when type in ["cash_dividend", "stock_dividend", "return_of_capital"], do: true
  def show_dividend_fields?(_), do: false

  def show_merger_fields?("merger"), do: true
  def show_merger_fields?(_), do: false

  def show_spinoff_fields?("spinoff"), do: true
  def show_spinoff_fields?(_), do: false

  def requires_split_ratios?("stock_split"), do: true
  def requires_split_ratios?(_), do: false

  def requires_dividend_amount?(type) when type in ["cash_dividend", "stock_dividend", "return_of_capital"], do: true
  def requires_dividend_amount?(_), do: false
end
```

#### 3.2 Add Changeset Validation

```elixir
# lib/ashfolio/portfolio/corporate_action.ex

defmodule Ashfolio.Portfolio.CorporateAction do
  # ... existing code ...

  def changeset(corporate_action, attrs) do
    corporate_action
    |> cast(attrs, [:action_type, :symbol_id, :ex_date, :description,
                    :split_ratio_from, :split_ratio_to, :dividend_amount,
                    :dividend_currency, :qualified_dividend, :exchange_ratio,
                    :cash_consideration, :new_symbol_id])
    |> validate_required([:action_type, :symbol_id, :ex_date])
    |> validate_conditional_fields()
  end

  defp validate_conditional_fields(changeset) do
    case get_field(changeset, :action_type) do
      "stock_split" ->
        changeset
        |> validate_required([:split_ratio_from, :split_ratio_to])
        |> validate_number(:split_ratio_from, greater_than: 0)
        |> validate_number(:split_ratio_to, greater_than: 0)

      type when type in ["cash_dividend", "stock_dividend", "return_of_capital"] ->
        changeset
        |> validate_required([:dividend_amount])
        |> validate_number(:dividend_amount, greater_than: 0)

      "merger" ->
        changeset
        |> validate_merger_fields()

      "spinoff" ->
        changeset
        |> validate_required([:new_symbol_id, :exchange_ratio])
        |> validate_number(:exchange_ratio, greater_than: 0)

      _ ->
        changeset
    end
  end

  defp validate_merger_fields(changeset) do
    exchange_ratio = get_field(changeset, :exchange_ratio)
    cash_consideration = get_field(changeset, :cash_consideration)

    if is_nil(exchange_ratio) and is_nil(cash_consideration) do
      changeset
      |> add_error(:exchange_ratio, "Either exchange ratio or cash consideration is required")
      |> add_error(:cash_consideration, "Either exchange ratio or cash consideration is required")
    else
      changeset
    end
  end
end
```

### Phase 4: Test Edge Cases

```elixir
# test/ashfolio_web/live/corporate_action_live/edge_cases_test.exs

describe "edge cases" do
  test "handles rapid action type changes", %{conn: conn} do
    {:ok, view, _html} = live(conn, ~p"/corporate-actions/new")

    # Rapidly change action types
    for type <- ["stock_split", "cash_dividend", "merger", "spinoff", "stock_split"] do
      view
      |> form("#corporate-action-form", %{"form" => %{"action_type" => type}})
      |> render_change()
    end

    # Should end with stock split fields visible
    assert has_element?(view, "#form_split_ratio_from")
  end

  test "preserves field values when switching between similar types", %{conn: conn} do
    {:ok, view, _html} = live(conn, ~p"/corporate-actions/new")

    # Enter dividend amount for cash dividend
    view
    |> form("#corporate-action-form", %{
      "form" => %{
        "action_type" => "cash_dividend",
        "dividend_amount" => "1.50"
      }
    })
    |> render_change()

    # Switch to stock dividend
    view
    |> form("#corporate-action-form", %{
      "form" => %{"action_type" => "stock_dividend"}
    })
    |> render_change()

    # Amount should be preserved
    assert view
           |> element("#form_dividend_amount")
           |> render() =~ "1.50"
  end

  test "clears incompatible fields when switching types", %{conn: conn} do
    {:ok, view, _html} = live(conn, ~p"/corporate-actions/new")

    # Enter split ratios
    view
    |> form("#corporate-action-form", %{
      "form" => %{
        "action_type" => "stock_split",
        "split_ratio_from" => "1",
        "split_ratio_to" => "2"
      }
    })
    |> render_change()

    # Switch to dividend
    view
    |> form("#corporate-action-form", %{
      "form" => %{"action_type" => "cash_dividend"}
    })
    |> render_change()

    # Split fields should not exist
    refute has_element?(view, "#form_split_ratio_from")
  end
end
```

## Testing Strategy

### 1. Run Tests Continuously

```bash
# Watch mode for immediate feedback
mix test.watch test/ashfolio_web/live/corporate_action_live

# Run specific test file
mix test test/ashfolio_web/live/corporate_action_live/form_component_test.exs

# Run with coverage
mix test --cover
```

### 2. Manual Testing Checklist

After each implementation step:

- [ ] Open browser to http://localhost:4000/corporate-actions/new
- [ ] Select each action type and verify fields appear
- [ ] Submit form with valid data
- [ ] Submit form with missing conditional fields
- [ ] Switch between action types rapidly
- [ ] Check browser console for errors

### 3. Performance Testing

```elixir
# Add timing to validate event
def handle_event("validate", params, socket) do
  start = System.monotonic_time()

  # ... validation logic ...

  duration = System.monotonic_time() - start
  Logger.debug("Validation took #{System.convert_time_unit(duration, :native, :microsecond)}Î¼s")

  {:noreply, socket}
end
```

## Implementation Sequence

1. **Hour 1**: Write all failing tests
2. **Hour 2**: Implement LiveView handle_event for validation
3. **Hour 3**: Update HEEx template with conditionals
4. **Hour 4**: Add changeset validations
5. **Hour 5**: Fix edge cases and refactor
6. **Hour 6**: Manual testing and documentation

## Success Criteria

- [ ] All tests pass (green)
- [ ] Conditional fields appear/disappear correctly
- [ ] Form submissions work for all action types
- [ ] Validation errors display properly
- [ ] No JavaScript console errors
- [ ] Performance: Field updates < 100ms
- [ ] Code coverage > 90% for form component

## Common Pitfalls to Avoid

1. **Don't forget to update assigns**: The `@action_type` must be in assigns
2. **Handle nil values**: Check for nil before rendering conditionals
3. **Validate on both client and server**: Don't trust client-side only
4. **Test the full lifecycle**: Create, edit, and delete
5. **Consider the database**: Ensure conditional fields are in the schema

## Rollback Plan

If implementation causes issues:

1. Keep current working version on main branch
2. Implement fix on feature branch
3. Run full test suite before merging
4. Have database migration rollback ready
5. Tag the last working version

## Monitoring After Fix

```elixir
# Add telemetry for form usage
:telemetry.execute(
  [:ashfolio, :corporate_action, :form],
  %{count: 1},
  %{action_type: action_type, fields_shown: count_visible_fields(socket)}
)
```

This TDD approach ensures the fix is thorough, tested, and maintainable.