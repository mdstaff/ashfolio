# v0.10.0 Implementation Plan: MCP Phase 2 + Consent UI

## Overview

Extend MCP integration with module registry, tool search, and user consent management. Uses a **hybrid parsing strategy**: simple utilities are rule-based, complex domain parsing leverages LLM-assisted structuring.

**Total Scope**: 7 stages, ~25-35 hours
**Deferred to v0.11.0**: P3-03 Audit Logging

---

## Stage 1: Parsing Foundation (Hybrid)

**Estimate**: 4-6 hours
**Blocked By**: None

### Approach

**Rule-based utilities** (fast, offline):
- Amount parsing (currency, K/M abbreviations, ranges)
- Date parsing (relative dates like "yesterday", "last month")

**LLM-assisted structuring** (complex domains):
- MCP tools return expected schema when given unstructured input
- LLM structures data, server validates and saves
- No complex regex patterns needed

### Deliverables

1. **Parseable Behaviour** (`lib/ashfolio/parsing/parseable.ex`)
   - Required: `name/0`, `input_schema/0`, `validate/1`, `execute/1`
   - Optional: `mcp_tool_definition/0`, `can_quick_parse?/1`, `quick_parse/1`
   - The `quick_parse` callbacks enable rule-based fast path

2. **Amount Parser** (`lib/ashfolio/parsing/amount_parser.ex`)
   - `parse/1` - Returns `{:ok, Decimal.t()}` or `{:error, reason}`
   - Handles: $1,800 | 85k | $50-100 | EUR 500
   - Always returns Decimal, never Float

3. **Schema Helpers** (`lib/ashfolio/parsing/schema.ex`)
   - `expense_schema/0` - Expected format for expenses
   - `transaction_schema/0` - Expected format for transactions
   - `validate_against_schema/2` - JSON Schema validation

### Tests
- `test/ashfolio/parsing/amount_parser_test.exs` (~25 tests)
- `test/ashfolio/parsing/parseable_test.exs` (~10 tests)

---

## Stage 2: P2-01 Parseable MCP Extension

**Estimate**: 2-3 hours
**Blocked By**: Stage 1

### Deliverables

1. **Parser Tool Executor** (`lib/ashfolio_web/mcp/parser_tool_executor.ex`)
   - Routes MCP calls to Parseable modules
   - Returns schema guidance for unstructured input
   - Validates structured input and executes

2. **Example: Add Expense Tool**
   - Unstructured: Returns expense schema + example
   - Structured: Validates and creates expense record

### Flow
```
Claude: "User wants to add rent expense of $1800"
  ↓
MCP add_expense({text: "rent $1800"})
  ↓
Response: {needs_structure: true, schema: {...}, example: {...}}
  ↓
Claude re-calls: add_expense({expenses: [{amount: "1800", category: "Housing", ...}]})
  ↓
Server validates → creates record → returns success
```

### Tests
- `test/ashfolio/parsing/parseable_mcp_test.exs` (~15 tests)

---

## Stage 3: P2-02 Module Registry

**Estimate**: 4-5 hours
**Blocked By**: Stage 2

### Deliverables

1. **Module Registry GenServer** (`lib/ashfolio_web/mcp/module_registry.ex`)
   - `all_tools/0` - All registered tools
   - `find_tool/1` - Lookup by name
   - `tools_for_mode/1` - Filter by privacy level
   - `register_tool/2` / `unregister_tool/1` - Runtime registration

2. **Discovery Sources**
   - Ash domains (existing 4 tools from Phase 1)
   - Parseable modules (new parsing tools)
   - Runtime registrations (future extensibility)

3. **Supervision** - Add to application.ex

### Tests
- `test/ashfolio_web/mcp/module_registry_test.exs` (~20 tests)

---

## Stage 4: P2-03 Tool Search

**Estimate**: 3-4 hours
**Blocked By**: Stage 3

### Deliverables

1. **Tool Search** (`lib/ashfolio_web/mcp/tool_search.ex`)
   - `search_tools` MCP tool
   - Keyword search across name/description
   - Category filtering
   - Privacy mode aware

2. **Scoring Algorithm**
   - Exact name match: 100 points
   - Name contains: 50 points
   - Description contains: 10 points

### Benefits
- 85% token reduction (per Anthropic pattern)
- Better tool selection through search

### Tests
- `test/ashfolio_web/mcp/tool_search_test.exs` (~15 tests)

---

## Stage 5: P3-01 Consent Resource

**Estimate**: 4-5 hours
**Blocked By**: None (parallel with Stages 2-4)

### Deliverables

1. **Legal Domain** (`lib/ashfolio/legal.ex`)

2. **AiConsent Resource** (`lib/ashfolio/legal/ai_consent.ex`)
   - Features: `:mcp_tools`, `:ai_analysis`, `:cloud_llm`
   - Privacy modes: `:strict`, `:anonymized`, `:standard`, `:full`
   - Versioning with terms hash
   - Grant/withdraw actions

3. **ConsentAudit Resource** (`lib/ashfolio/legal/consent_audit.ex`)
   - Append-only audit trail
   - Actions: granted, withdrawn, gdpr_export, gdpr_deletion

4. **Migration** - ai_consents + consent_audits tables

### Tests
- `test/ashfolio/legal/ai_consent_test.exs` (~25 tests)

---

## Stage 6: P3-02 Consent UI

**Estimate**: 4-5 hours
**Blocked By**: Stage 5

### Deliverables

1. **Consent Modal** (`lib/ashfolio_web/components/consent_modal.ex`)
   - Privacy mode selection with explanations
   - Terms acceptance checkbox
   - Grant/Decline buttons
   - ARIA accessible

2. **Consent Check Hook** (`lib/ashfolio_web/hooks/consent_check.ex`)
   - Intercepts AI feature access
   - Shows modal if no valid consent

### Tests
- `test/ashfolio_web/live/consent_modal_test.exs` (~20 tests)

---

## Stage 7: P3-04 Settings LiveView (Reduced)

**Estimate**: 3-4 hours
**Blocked By**: Stage 6

### Reduced Scope
- **Removed**: Audit log section (deferred with P3-03)

### Deliverables

1. **AI Settings Page** (`lib/ashfolio_web/live/settings/ai_settings_live.ex`)
   - Consent status display
   - Privacy mode change with confirmation
   - Consent revocation
   - GDPR data export

2. **Router** - Add `/settings/ai` route

### Tests
- `test/ashfolio_web/live/settings/ai_settings_live_test.exs` (~15 tests)

---

## Execution Order

```
Week 1:
├─ Stage 1: Parsing Foundation (4-6h)
├─ Stage 5: Consent Resource (4-5h) [parallel]
└─ Stage 2: Parseable MCP (2-3h)

Week 2:
├─ Stage 3: Module Registry (4-5h)
├─ Stage 6: Consent UI (4-5h) [parallel]
└─ Stage 4: Tool Search (3-4h)

Week 3:
└─ Stage 7: Settings LiveView (3-4h)
```

---

## Critical Files

| File | Purpose |
|------|---------|
| `lib/ashfolio/parsing/parseable.ex` | Behaviour definition |
| `lib/ashfolio/parsing/amount_parser.ex` | Rule-based amount parsing |
| `lib/ashfolio/parsing/schema.ex` | Schema definitions for LLM structuring |
| `lib/ashfolio_web/mcp/module_registry.ex` | Central tool registry |
| `lib/ashfolio_web/mcp/tool_search.ex` | Token-saving search |
| `lib/ashfolio/legal/ai_consent.ex` | GDPR-compliant consent |
| `lib/ashfolio_web/components/consent_modal.ex` | User consent UX |

---

## Test Summary

| Stage | New Tests |
|-------|-----------|
| 1. Parsing Foundation | ~35 |
| 2. Parseable MCP | ~15 |
| 3. Module Registry | ~20 |
| 4. Tool Search | ~15 |
| 5. Consent Resource | ~25 |
| 6. Consent UI | ~20 |
| 7. Settings LiveView | ~15 |
| **Total** | **~145** |

---

## Deferred to v0.11.0

- P3-03 Audit Logging (tool invocation tracking)
- Audit log UI in settings page
- Full expense/income/account parsers (only foundation in v0.10.0)

---

## Key Design Decisions

1. **Hybrid Parsing**: Rule-based for simple utilities (fast, offline), LLM-assisted for complex domains (flexible, no regex maintenance)

2. **Schema-First**: MCP tools define expected input schemas; unstructured input returns schema guidance

3. **Consent Before Features**: Modal intercepts AI feature access until consent granted

4. **Privacy Mode Per-Consent**: Each consent records the privacy level chosen
