# v0.6.0 TDD Backlog - Professional Standards & Tax Accuracy

> Test-Driven Development task breakdown for Ashfolio v0.6.0
> Priority: Corporate Actions Engine â†’ Tax Documents â†’ Risk Analytics â†’ Portfolio Optimization

## Pre-Development Tasks (Week 0)

### Test Suite Stabilization âš ï¸ BLOCKING
- [ ] Fix BenchmarkAnalyzer mock verification errors
- [ ] Resolve YahooFinanceMock redefinition warnings  
- [ ] Fix PubSub async test race conditions
- [ ] Clean up unused variable warnings in MoneyRatiosLive tests
- [ ] Ensure all 1,669 tests pass consistently

### Development Environment Setup
- [ ] Create v0.6.0 feature branch
- [ ] Set up GitHub milestone for v0.6.0
- [ ] Configure CI/CD for feature branch
- [ ] Update IMPLEMENTATION_PLAN.md template

---

## Phase 1: Corporate Actions Engine (Weeks 1-4) ðŸ† HIGHEST PRIORITY

### Week 1: Core Infrastructure & Stock Splits

#### Test Suite: Corporate Actions Foundation
```elixir
test/ashfolio/portfolio/corporate_actions_test.exs
```
- [ ] Test: Corporate action event structure validation
- [ ] Test: Event date tracking and ordering
- [ ] Test: Audit trail generation for adjustments
- [ ] Test: Transaction immutability after adjustments

#### Test Suite: Stock Split Handler
```elixir
test/ashfolio/portfolio/corporate_actions/stock_split_test.exs
```
- [ ] Test: 2:1 forward split adjusts shares and cost basis
- [ ] Test: 1:2 reverse split adjusts shares and cost basis
- [ ] Test: 3:2 split with fractional shares handling
- [ ] Test: Split maintains total portfolio value
- [ ] Test: Split preserves FIFO ordering
- [ ] Test: Historical transactions show adjustment notes
- [ ] Test: Split on ex-date affects only shares held before date
- [ ] Test: Multiple splits compound correctly
- [ ] Test: Split with open tax lots maintains lot integrity

#### Implementation Tasks
- [ ] Create CorporateAction Ash resource
- [ ] Implement StockSplit calculator module
- [ ] Add split adjustment to Transaction model
- [ ] Create split application service
- [ ] Add UI for manual split entry

### Week 2: Dividends & Distributions

#### Test Suite: Dividend Handler
```elixir
test/ashfolio/portfolio/corporate_actions/dividend_test.exs
```
- [ ] Test: Cash dividend adds to cash balance
- [ ] Test: Stock dividend increases share count
- [ ] Test: Special dividend tracking
- [ ] Test: Qualified dividend status determination (>60 day holding)
- [ ] Test: Ex-dividend date share ownership validation
- [ ] Test: Dividend reinvestment at market price
- [ ] Test: Foreign dividend withholding tracking
- [ ] Test: Return of capital reduces cost basis
- [ ] Test: Capital gain distribution recognition

#### Test Suite: Tax Lot Impact
```elixir
test/ashfolio/portfolio/corporate_actions/tax_lot_impact_test.exs
```
- [ ] Test: Dividend allocation across multiple tax lots
- [ ] Test: Return of capital basis adjustment per lot
- [ ] Test: Basis cannot go below zero
- [ ] Test: Excess return of capital becomes capital gain

#### Implementation Tasks
- [ ] Create Dividend resource and types
- [ ] Implement qualified dividend calculator
- [ ] Add dividend tax rate determination
- [ ] Create dividend reinvestment processor
- [ ] Add dividend UI and reporting

### Week 3: Mergers & Acquisitions

#### Test Suite: Merger Handler
```elixir
test/ashfolio/portfolio/corporate_actions/merger_test.exs
```
- [ ] Test: All-stock merger (1:1 symbol conversion)
- [ ] Test: Stock merger with ratio (e.g., 0.5 shares per share)
- [ ] Test: Cash merger creates realized gain/loss
- [ ] Test: Mixed cash+stock merger allocation
- [ ] Test: Merger maintains original purchase dates
- [ ] Test: Cost basis carries forward in stock merger
- [ ] Test: Fractional shares cash-out in merger
- [ ] Test: Multiple account merger handling
- [ ] Test: Merger with boot (taxable portion)

#### Test Suite: Spin-offs
```elixir
test/ashfolio/portfolio/corporate_actions/spinoff_test.exs
```
- [ ] Test: Spin-off basis allocation per IRS guidelines
- [ ] Test: Parent and child company share distribution
- [ ] Test: Fair market value determination at spin
- [ ] Test: Cost basis split between entities
- [ ] Test: Spin-off maintains FIFO lots

#### Implementation Tasks
- [ ] Create Merger/Acquisition processor
- [ ] Implement symbol conversion system
- [ ] Add basis allocation calculator
- [ ] Create spin-off handler
- [ ] Build corporate action import system

### Week 4: Integration & Edge Cases

#### Test Suite: Complex Scenarios
```elixir
test/ashfolio/portfolio/corporate_actions/complex_scenarios_test.exs
```
- [ ] Test: Split followed by dividend
- [ ] Test: Merger with pending dividends
- [ ] Test: Bankruptcy and delisting
- [ ] Test: Rights offerings and warrants
- [ ] Test: Tender offers
- [ ] Test: Multiple actions on same day
- [ ] Test: Retroactive adjustment handling
- [ ] Test: Corporate action reversal/correction

#### Performance Tests
```elixir
test/ashfolio/portfolio/corporate_actions/performance_test.exs
```
- [ ] Test: Process 1000+ splits in <100ms
- [ ] Test: Handle 10-year history adjustments
- [ ] Test: Concurrent corporate action processing

---

## Phase 2: Tax Document Generation (Weeks 5-6)

### Week 5: IRS Form Generation

#### Test Suite: Schedule D Generator
```elixir
test/ashfolio/tax/schedule_d_test.exs
```
- [ ] Test: Short-term vs long-term classification
- [ ] Test: Gain/loss calculation accuracy
- [ ] Test: Wash sale adjustment inclusion
- [ ] Test: Carryover loss handling
- [ ] Test: Format matches IRS specification
- [ ] Test: Multiple brokers consolidation

#### Test Suite: Form 8949 Generator
```elixir
test/ashfolio/tax/form_8949_test.exs
```
- [ ] Test: Transaction-level detail reporting
- [ ] Test: Basis adjustment codes (W, D, etc.)
- [ ] Test: Date acquired for FIFO lots
- [ ] Test: Covered vs non-covered securities
- [ ] Test: Adjustment explanations
- [ ] Test: CSV export format

#### Test Suite: 1099-B Reconciliation
```elixir
test/ashfolio/tax/form_1099b_reconciliation_test.exs
```
- [ ] Test: Match broker reported amounts
- [ ] Test: Identify discrepancies
- [ ] Test: Missing cost basis handling
- [ ] Test: Proceeds reconciliation
- [ ] Test: Multi-broker consolidation

### Week 6: State & Advanced Tax Reports

#### Test Suite: State Tax Allocation
```elixir
test/ashfolio/tax/state_allocation_test.exs
```
- [ ] Test: Residence-based allocation
- [ ] Test: Multi-state year handling
- [ ] Test: State-specific adjustments
- [ ] Test: Non-resident withholding

#### Test Suite: Estimated Tax Calculator
```elixir
test/ashfolio/tax/estimated_tax_test.exs
```
- [ ] Test: Quarterly payment calculation
- [ ] Test: Safe harbor determination
- [ ] Test: Prior year AGI consideration
- [ ] Test: Annualization method
- [ ] Test: Penalty avoidance threshold

---

## Phase 3: Risk Analytics Suite (Weeks 7-8)

### Week 7: Core Risk Metrics

#### Test Suite: Risk Calculations
```elixir
test/ashfolio/analytics/risk_metrics_test.exs
```
- [ ] Test: Sharpe ratio calculation (excess return/std dev)
- [ ] Test: Sortino ratio (downside deviation)
- [ ] Test: Information ratio vs benchmark
- [ ] Test: Maximum drawdown calculation
- [ ] Test: Value at Risk (95% confidence)
- [ ] Test: Beta calculation vs market
- [ ] Test: Standard deviation (daily/annual)
- [ ] Test: Treynor ratio
- [ ] Test: Calmar ratio

#### Test Suite: Risk Edge Cases
```elixir
test/ashfolio/analytics/risk_edge_cases_test.exs
```
- [ ] Test: Insufficient data handling (<3 years)
- [ ] Test: Zero volatility periods
- [ ] Test: Negative returns handling
- [ ] Test: Missing data interpolation
- [ ] Test: Extreme market events

### Week 8: Risk Reporting & Caching

#### Test Suite: Risk Reports
```elixir
test/ashfolio/analytics/risk_reports_test.exs
```
- [ ] Test: IPS-compliant report generation
- [ ] Test: Risk metric trends over time
- [ ] Test: Peer comparison benchmarks
- [ ] Test: Risk attribution analysis
- [ ] Test: PDF export formatting

#### Performance Tests
```elixir
test/ashfolio/analytics/risk_performance_test.exs
```
- [ ] Test: Calculate all metrics in <100ms
- [ ] Test: Cache invalidation on new data
- [ ] Test: Concurrent calculation handling

---

## Phase 4: Portfolio Optimization (Weeks 9-10)

### Week 9: Tax-Aware Rebalancing

#### Test Suite: Rebalancing Engine
```elixir
test/ashfolio/portfolio/rebalancing_test.exs
```
- [ ] Test: Target allocation deviation detection
- [ ] Test: Rebalancing band triggers (5%, 10%)
- [ ] Test: Tax-aware lot selection
- [ ] Test: Minimize realized gains strategy
- [ ] Test: Tax budget constraints ($X max gains)
- [ ] Test: Wash sale rule compliance
- [ ] Test: Transaction cost minimization
- [ ] Test: Asset location optimization

#### Test Suite: Trade Generation
```elixir
test/ashfolio/portfolio/trade_generation_test.exs
```
- [ ] Test: Specific lot identification
- [ ] Test: Order generation for brokers
- [ ] Test: Pre-trade tax impact estimate
- [ ] Test: Multi-account coordination
- [ ] Test: Threshold-based execution

### Week 10: Advanced Optimization

#### Test Suite: Asset Location
```elixir
test/ashfolio/portfolio/asset_location_test.exs
```
- [ ] Test: Tax-inefficient assets in IRA
- [ ] Test: Tax-efficient assets in taxable
- [ ] Test: Municipal bonds in high-tax states
- [ ] Test: International tax credit optimization
- [ ] Test: REIT placement optimization

---

## Phase 5: RMD & Roth Conversion (Weeks 11-12)

### Week 11: Required Minimum Distributions

#### Test Suite: RMD Calculator
```elixir
test/ashfolio/retirement/rmd_calculator_test.exs
```
- [ ] Test: Age-based RMD calculation (73+)
- [ ] Test: Uniform lifetime table accuracy
- [ ] Test: Joint life table for younger spouse
- [ ] Test: Inherited IRA 10-year rule
- [ ] Test: Multiple IRA aggregation
- [ ] Test: Roth IRA exclusion
- [ ] Test: First-year April 1 deadline
- [ ] Test: 50% penalty calculation
- [ ] Test: QCD optimization up to $100k

### Week 12: Roth Conversion Optimizer

#### Test Suite: Roth Conversion
```elixir
test/ashfolio/retirement/roth_conversion_test.exs
```
- [ ] Test: Tax bracket fill-up strategy
- [ ] Test: IRMAA cliff avoidance
- [ ] Test: Multi-year ladder planning
- [ ] Test: State tax differential
- [ ] Test: Pro-rata rule calculation
- [ ] Test: Recharacterization deadline
- [ ] Test: 5-year rule tracking
- [ ] Test: Estate tax consideration

---

## Testing Standards & Requirements

### Coverage Requirements by Module
- Corporate Actions: 100% branch coverage
- Tax Calculations: 100% + IRS test cases
- Risk Metrics: 95% + academic validation
- Optimization: 90% + scenario testing

### Performance Benchmarks
- Corporate Actions: <100ms for 1000 events
- Tax Forms: <2s for annual generation
- Risk Metrics: <100ms per calculation
- Rebalancing: <500ms for 100 positions

### Test Data Requirements
Each test suite must include:
- [ ] Normal market conditions
- [ ] 2008 financial crisis scenario
- [ ] 2020 COVID volatility
- [ ] Dot-com bubble (1999-2001)
- [ ] Black Monday (1987)
- [ ] Zero/negative interest rates
- [ ] High inflation (1970s)

### Documentation Requirements
Each test must have:
- Clear test name describing scenario
- Expected behavior documentation
- Financial formula reference
- Edge case handling notes

---

## Success Criteria

### Phase Completion Gates
- [ ] All tests written and passing
- [ ] Performance benchmarks met
- [ ] Code coverage targets achieved
- [ ] Documentation complete
- [ ] Integration tests passing
- [ ] CFP/CPA validation sign-off

### Overall v0.6.0 Release Criteria
- [ ] 1,800+ total tests (up from 1,669)
- [ ] Zero Credo warnings
- [ ] All financial calculations use Decimal
- [ ] FIFO consistency maintained
- [ ] Audit trail for all adjustments
- [ ] Professional documentation complete

---

## Risk Mitigation

### Technical Risks
- [ ] Set up continuous benchmark testing
- [ ] Create rollback procedures for corporate actions
- [ ] Implement comprehensive audit logging
- [ ] Add data validation at every layer

### Regulatory Risks
- [ ] Track IRS rule changes
- [ ] Implement configurable tax rules
- [ ] Maintain calculation transparency
- [ ] Create compliance audit reports

---

*This TDD backlog ensures comprehensive test coverage for all v0.6.0 features, with tests written before implementation following Red-Green-Refactor methodology.*